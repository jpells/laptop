#!/bin/bash

# Restore script - pulls backup data FROM NAS TO local machine
# Run this on a fresh machine BEFORE enabling the backup cronjob
# Generated by Ansible - do not edit directly

# Variables
MOUNT_POINT="{{ laptop_backup_mount_point }}"
SHARE="{{ laptop_backup_share }}"
HOST_NAME="{{ laptop_backup_host_name }}"
RSYNC_OPTIONS=(
    --archive
    --copy-links
    --verbose
    --stats
    --itemize-changes
    --human-readable
)

# Mount the Samba share
if ! /sbin/mount | grep -q "$MOUNT_POINT"; then
    mkdir -p "$MOUNT_POINT"
    /sbin/mount -t smbfs "$SHARE" "$MOUNT_POINT"
    if [ $? -ne 0 ]; then
        echo "Failed to mount Samba share."
        exit 1
    fi
fi

# Check if remote backup exists
if [ ! -d "$MOUNT_POINT/$HOST_NAME" ]; then
    echo "No backup found at $MOUNT_POINT/$HOST_NAME"
    /sbin/umount "$MOUNT_POINT"
    rmdir "$MOUNT_POINT" 2>/dev/null
    exit 1
fi

echo "Restoring backup from NAS..."

{% for item in laptop_backup_items %}
# Restore {{ item.name }}
if [ -{% if item.is_dir | default(false) %}d{% else %}e{% endif %} "$MOUNT_POINT/$HOST_NAME/{{ item.name }}" ]; then
    echo "Restoring {{ item.name }}..."
{% if item.is_dir | default(false) %}
    mkdir -p "{{ item.dest }}"
    rsync "${RSYNC_OPTIONS[@]}" "$MOUNT_POINT/$HOST_NAME/{{ item.name }}/" "{{ item.dest }}/"
{% if item.mode is defined %}
    chmod {{ item.mode }} "{{ item.dest }}"
{% endif %}
{% if item.file_mode is defined %}
    chmod {{ item.file_mode }} "{{ item.dest }}"/* 2>/dev/null
{% endif %}
{% else %}
    mkdir -p "{{ item.dest }}"
    rsync "${RSYNC_OPTIONS[@]}" "$MOUNT_POINT/$HOST_NAME/{{ item.name }}" "{{ item.dest }}/"
{% endif %}
fi

{% endfor %}
# Unmount the NetBackup share
/sbin/umount "$MOUNT_POINT"
rmdir "$MOUNT_POINT" 2>/dev/null

echo "Restore completed successfully."
echo "You can now run: ansible-playbook laptop.yml --tags backup"
exit 0
