#!/bin/bash
# NOTE: Privacy & Security -> Full Disk Access + /usr/sbin/cron
# Generated by Ansible - do not edit directly

# Variables
MOUNT_POINT="{{ laptop_backup_mount_point }}"
SHARE="{{ laptop_backup_share }}"
LOCAL_DIR="{{ laptop_backup_dir }}"
RSYNC_OPTIONS=(
    --archive
    --copy-links
    --delete
    --verbose
    --stats
    --itemize-changes
    --human-readable
{% for exclude in laptop_backup_rsync_excludes %}
    --exclude='{{ exclude }}'
{% endfor %}
)
HOST_NAME="{{ laptop_backup_host_name }}"

# Mount the Samba share
if ! /sbin/mount | grep -q "$MOUNT_POINT"; then
    mkdir -p "$MOUNT_POINT"
    /sbin/mount -t smbfs "$SHARE" "$MOUNT_POINT"
    if [ $? -ne 0 ]; then
        echo "Failed to mount Samba share."
        exit 1
    fi
fi

# Safety check: prevent overwriting remote backup with empty local data
{% for item in laptop_backup_items %}
if [ ! -{% if item.is_dir %}d{% else %}e{% endif %} "{{ item.src }}" ] && [ -{% if item.is_dir %}d{% else %}e{% endif %} "$MOUNT_POINT/$HOST_NAME/{{ item.name }}" ]; then
    echo "SAFETY ABORT: {{ item.name }} missing locally but exists in remote backup."
    echo "Run 'ansible-playbook laptop.yml --tags restore' first."
    /sbin/umount "$MOUNT_POINT"
    rmdir "$MOUNT_POINT" 2>/dev/null
    exit 1
fi
{% endfor %}

# Run rsync
rsync "${RSYNC_OPTIONS[@]}" "$LOCAL_DIR/" "$MOUNT_POINT/$HOST_NAME/"
if [ $? -ne 0 ]; then
    echo "rsync failed."
    /sbin/umount "$MOUNT_POINT"
    exit 1
fi

# Unmount the Samba share
/sbin/umount "$MOUNT_POINT"
if [ $? -ne 0 ]; then
    echo "Failed to unmount Samba share."
    exit 1
fi

# Remove the directory
rmdir "$MOUNT_POINT"
if [ $? -ne 0 ]; then
    echo "Failed to remove mount point directory."
    exit 1
fi

echo "Backup completed successfully."
exit 0
